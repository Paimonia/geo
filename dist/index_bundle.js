(()=>{"use strict";class e{constructor(){this.reviewForm=document.getElementById("review_form"),this.addressElement=document.getElementById("address"),this.closeFormBtn=document.getElementById("close_form"),this.reviewList=document.getElementById("review_list"),this.emptyMessage=document.getElementById("empty_message"),this.reviewerName=document.getElementById("reviewer_name"),this.reviewPlace=document.getElementById("place"),this.reviewText=document.getElementById("review_text"),this.saveBtn=document.getElementById("saveBtn"),this.closeFormBtn.addEventListener("click",(()=>this.closeForm()))}clearInputs(){this.reviewerName.value="",this.reviewPlace.value="",this.reviewText.value=""}clearForm(){this.addressElement.textContent="",this.clearInputs(),this.clearReviewList()}clearReviewList(){this.reviewList.innerHTML="",this.emptyMessage.style.display="block"}updateReviewList(e){e?(this.emptyMessage.style.display="none",this.reviewList.innerHTML=e):this.clearReviewList()}closeForm(){this.clearForm(),this.clearReviewList(),this.reviewForm.style.display="none"}showForm(e,t,s){let{x:i,y:r}=e;this.reviewForm.style.left=i+"px",this.reviewForm.style.top=r+"px",this.reviewForm.style.display="block",this.reviewForm.style.zIndex="10",this.addressElement.textContent=t,this.updateReviewList(s),this.reviewerName.focus()}}class t{constructor(){this.formElement=document.getElementById("review_form"),this.geoReviewForm=new e}getFormOffsets(e){let{x:t,y:s}=e;return t=t<0?0:t,t+this.formElement.offsetWidth>document.documentElement.clientWidth&&(t=document.documentElement.clientWidth-this.formElement.offsetWidth-10),s=s<0?0:s,s+this.formElement.offsetHeight>document.documentElement.clientHeight&&(s=document.documentElement.clientHeight-this.formElement.offsetHeight-10),{x:t,y:s}}getReviewList(e,t){let s="";for(let i of t)i.address===e&&(s+=`<li>\n                <span class="username">${i.reviewer} </span>\n                <span class="place"> ${i.place}</span> <span class="date">${i.date}</span>\n                <div class="review-text">${i.text}</div>\n                </li>`);return s}}class s{constructor(){this.localStoragiItem="geo_reviews",this.currentReview={},this.allReviews=this.loadReviewsFromStorage()}saveReviewsToStorage(){localStorage[this.localStoragiItem]=JSON.stringify(this.allReviews)}loadReviewsFromStorage(){return localStorage[this.localStoragiItem]?JSON.parse(localStorage[this.localStoragiItem]):[]}isEmptyFieldInCurrentReview(){return!(this.currentReview.reviewer&&this.currentReview.place||this.currentReview.text)}addCurrentReviewInAllReviews(){this.allReviews.push(Object.assign({},this.currentReview))}getCoordsByAddress(e){let t=[];for(let s of this.allReviews)if(s.address===e){t=[...s.coords];break}return t}fillCurrentReview(e){this.currentReview.address=e,this.currentReview.coords=this.getCoordsByAddress(e)}}class i{constructor(){this.model=new s,this.view=new t,this.mapElement=document.getElementById("map"),this.myMap=this.createMap(),this.clusterer=this.createClusterer(),this.myMap.geoObjects.add(this.clusterer),this.myMap.events.add("click",(e=>{let t=e.get("coords"),s=e.get("position");this.view.geoReviewForm.clearForm(),ymaps.geocode(t).then((e=>{this.model.currentReview.coords=t,this.model.currentReview.address=e.geoObjects.get(0).getAddressLine(),this.view.geoReviewForm.showForm(this.view.getFormOffsets(s),this.model.currentReview.address,"")})).catch((e=>console.error(e)))})),this.addEventHandlers()}addEventHandlers(){this.view.geoReviewForm.saveBtn.addEventListener("click",(()=>this.addReview())),this.mapElement.addEventListener("click",(e=>{let t=e.target;if("balloon__address"===t.className){const s={x:e.clientX,y:e.clientY};let i=t.textContent;this.model.fillCurrentReview(i),this.myMap.balloon.close(),this.view.geoReviewForm.showForm(this.view.getFormOffsets(s),i,this.view.getReviewList(i,this.model.allReviews))}}))}createMap(){let e=new ymaps.Map("map",{center:[55.755508,37.617187],zoom:16,behaviors:["drag","scrollZoom"]});return e.controls.add("zoomControl"),e}getClustererWithCarousel(){let e=ymaps.templateLayoutFactory.createClass("<div class=balloon__header>{{ properties.balloonContentHeader|raw }}</div><div class=balloon__body>{{ properties.balloonContentBody|raw }}</div><div class=balloon__footer>{{ properties.balloonContentFooter|raw }}</div>");return new ymaps.Clusterer({preset:"islands#invertedDarkOrangeClusterIcons",openBalloonOnClick:!0,clusterDisableClickZoom:!0,clusterOpenBalloonOnClick:!0,clusterHideIconOnBalloonOpen:!1,clusterBalloonContentLayout:"cluster#balloonCarousel",clusterBalloonItemContentLayout:e,clusterBalloonPanelMaxMapArea:0,clusterBalloonContentLayoutWidth:200,clusterBalloonContentLayoutHeight:130,clusterBalloonPagerSize:5})}createClusterer(){return this.getClustererWithCarousel()}addPlacemark(e){let{coords:t,address:s,reviewer:i,place:r,date:o,text:l}=e,a=new ymaps.Placemark(t,{balloonContentHeader:`<div class="balloon__place">${r}</div><div class="balloon__address">${s}</div>`,balloonContentBody:l,balloonContentFooter:o,hintContent:`<b>${i}</b> ${r}`},{preset:"islands#redIcon",iconColor:"#df6543",openBalloonOnClick:!1});a.events.add("click",(e=>{this.model.fillCurrentReview(s),this.view.geoReviewForm.showForm(this.view.getFormOffsets(e.get("position")),s,this.view.getReviewList(s,this.model.allReviews))})),this.clusterer.add(a)}addAllPlacemarks(){this.model.allReviews.forEach(((e,t,s)=>this.addPlacemark(e)))}fillCurrentReviewFromInputs(){this.model.currentReview.reviewer=this.view.geoReviewForm.reviewerName.value,this.model.currentReview.place=this.view.geoReviewForm.reviewPlace.value,this.model.currentReview.text=this.view.geoReviewForm.reviewText.value,this.model.currentReview.date=(new Date).toLocaleString()}addReview(){if(this.fillCurrentReviewFromInputs(),this.model.isEmptyFieldInCurrentReview())return;this.model.addCurrentReviewInAllReviews(),this.model.saveReviewsToStorage(),this.addPlacemark(this.model.currentReview);let e=this.model.currentReview.address;this.view.geoReviewForm.updateReviewList(this.view.getReviewList(e,this.model.allReviews)),this.view.geoReviewForm.clearInputs()}}ymaps.ready((function(){(new i).addAllPlacemarks()}))})();